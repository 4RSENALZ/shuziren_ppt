<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC webcam</title>
    <style>
    button {
        padding: 8px 16px;
    }

    video {
        width: 100%;
    }

    .option {
        margin-bottom: 8px;
    }

    #media {
        max-width: 1280px;
    }

    #chat-panel {
        margin-top: 16px;
        max-width: 640px;
    }

    #chat-panel h3 {
        margin-bottom: 8px;
        font-size: 1.1rem;
    }

    #chat-log {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: #f8fafc;
        padding: 12px;
        height: 220px;
        overflow-y: auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 0.95rem;
        line-height: 1.45;
    }

    .chat-message {
        margin-bottom: 8px;
    }

    .chat-message:last-child {
        margin-bottom: 0;
    }

    .chat-message.user {
        color: #2563eb;
    }

    .chat-message.assistant {
        color: #047857;
    }

    .chat-message.system {
        color: #6b7280;
        font-style: italic;
    }
    </style>
</head>
<body>

<div class="option">
    <input id="use-stun" type="checkbox"/>
    <label for="use-stun">Use STUN server</label>
</div>
<button id="start" onclick="startChat()">Start</button>
<button id="stop" style="display: none" onclick="stop()">Stop</button>
<button class="btn btn-primary" id="btn_start_record">Start Recording</button>
<button class="btn btn-primary" id="btn_stop_record" disabled>Stop Recording</button>
<!-- <button class="btn btn-primary" id="btn_download">Download Video</button> -->
<input type="hidden" id="sessionid" value="0">
<form class="form-inline" id="echo-form">
    <div class="form-group">
      <p>input text</p>

      <textarea cols="2" rows="3" style="width:600px;height:50px;" class="form-control" id="message">test</textarea>
    </div>
    <button type="submit" class="btn btn-default">Send</button>
  </form>

<div id="chat-panel">
    <h3>对话记录</h3>
    <div id="chat-log"></div>
</div>

<div id="media">
    <h2>Media</h2>

    <audio id="audio" autoplay="true"></audio>
    <video id="video" style="width:600px;" autoplay="true" playsinline="true"></video>
</div>

<script src="client.js"></script>
<script type="text/javascript" src="http://cdn.sockjs.org/sockjs-0.3.4.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</body>
<script type="text/javascript" charset="utf-8">
let chatLogEl = null;
let lastMessageId = 0;
let chatPollTimer = null;

const chatRoleLabels = {
    user: '用户',
    assistant: '数字人',
    system: '系统',
};

function formatChatTimestamp(timestamp) {
    if (typeof timestamp !== 'number' || !Number.isFinite(timestamp) || timestamp <= 0) {
        return '';
    }
    try {
        const date = new Date(timestamp * 1000);
        if (Number.isNaN(date.getTime())) {
            return '';
        }
        return date.toLocaleTimeString();
    } catch (err) {
        return '';
    }
}

function appendChatMessage(message) {
    if (!chatLogEl || !message) {
        return;
    }
    if (!chatLogEl.length) {
        return;
    }
    const role = typeof message.role === 'string' ? message.role : 'assistant';
    const rawText = typeof message.text === 'string' ? message.text : '';
    const text = rawText.trim();
    if (!text) {
        return;
    }
    const label = chatRoleLabels[role] || role;
    const timeLabel = formatChatTimestamp(message.timestamp);
    const entry = $('<div/>').addClass('chat-message').addClass(role);
    const displayText = timeLabel ? `[${timeLabel}] ${label}：${text}` : `${label}：${text}`;
    entry.text(displayText);
    if (message.meta && message.meta.source) {
        entry.attr('data-source', message.meta.source);
    }
    chatLogEl.append(entry);
    const hostEl = chatLogEl[0];
    if (hostEl) {
        hostEl.scrollTop = hostEl.scrollHeight;
    }
}

function syncChatMessages(messages) {
    if (!Array.isArray(messages) || !messages.length) {
        return;
    }
    messages.forEach((msg) => {
        if (msg && typeof msg.id === 'number' && msg.id > lastMessageId) {
            appendChatMessage(msg);
            if (msg.id > lastMessageId) {
                lastMessageId = msg.id;
            }
        }
    });
}

function fetchChatMessages() {
    if (!chatLogEl || !chatLogEl.length) {
        return;
    }
    const sessionRaw = $('#sessionid').val();
    const sessionId = parseInt(sessionRaw, 10) || 0;
    if (!sessionId) {
        return;
    }
    fetch(`/chat/history?sessionid=${sessionId}&after=${lastMessageId}`)
        .then((response) => response.json())
        .then((payload) => {
            if (payload && payload.code === 0 && Array.isArray(payload.messages)) {
                syncChatMessages(payload.messages);
            } else if (payload && payload.msg) {
                console.warn('chat history error:', payload.msg);
            }
        })
        .catch((error) => {
            console.warn('chat history fetch failed', error);
        });
}

function resetChatLog() {
    lastMessageId = 0;
    if (chatLogEl && chatLogEl.length) {
        chatLogEl.empty();
    }
}

function startChat() {
    resetChatLog();
    fetchChatMessages();
    start();
}

$(document).ready(function() {
  chatLogEl = $('#chat-log');
  fetchChatMessages();
  chatPollTimer = setInterval(fetchChatMessages, 1500);

  $('#echo-form').on('submit', function(e) {
      e.preventDefault();
      var message = $('#message').val();
      if (typeof message === 'string') {
          message = message.trim();
      }
      if (!message) {
          return;
      }
      var sessionValue = parseInt(document.getElementById('sessionid').value, 10) || 0;
      if (!sessionValue) {
          console.warn('Session not ready, please start the stream first.');
          return;
      }
      fetch('/human', {
            body: JSON.stringify({
                text: message,
                type: 'chat',
                interrupt: true,
                sessionid: sessionValue,
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            method: 'POST'
      })
      .then(function(response) {
          return response.json();
      })
      .then(function(payload) {
          if (!payload || payload.code !== 0) {
              var errMsg = (payload && payload.msg) ? payload.msg : '发送失败，请稍后重试。';
              alert(errMsg);
          } else {
              fetchChatMessages();
          }
      })
      .catch(function(error) {
          console.error('Send chat failed:', error);
          alert('发送失败，请稍后重试。');
      });
      $('#message').val('');
  });

  $('#btn_start_record').click(function() {
        console.log('Starting recording...');
        fetch('/record', {
            body: JSON.stringify({
                    type: 'start_record',
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
            method: 'POST'
        }).then(function(response) {
            if (response.ok) {
                console.log('Recording started.');
                $('#btn_start_record').prop('disabled', true);
                $('#btn_stop_record').prop('disabled', false);
            } else {
                console.error('Failed to start recording.');
            }
        }).catch(function(error) {
            console.error('Error:', error);
        });
    });

    $('#btn_stop_record').click(function() {
        console.log('Stopping recording...');
        fetch('/record', {
            body: JSON.stringify({
                    type: 'end_record',
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
            method: 'POST'
        }).then(function(response) {
            if (response.ok) {
                console.log('Recording stopped.');
                $('#btn_start_record').prop('disabled', false);
                $('#btn_stop_record').prop('disabled', true);
            } else {
                console.error('Failed to stop recording.');
            }
        }).catch(function(error) {
            console.error('Error:', error);
        });
    });
});

</script>
</html>
